{% extends 'base.html' %}
{% load static %}

{% block title %}Notifications · Vehicle Compliance{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-6">
  <div>
    <h1 class="text-xl font-semibold text-gray-900">Notifications</h1>
    <p class="mt-1 text-sm text-gray-500">Review important updates about policies, payments, and compliance.</p>
  </div>
  <div>
    <button type="button" onclick="markAllAsRead()" class="inline-flex items-center px-3 py-1.5 text-xs font-medium text-blue-700 bg-blue-50 hover:bg-blue-100 rounded-lg border border-blue-100">
      Mark all as read
    </button>
  </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
  <div class="lg:col-span-3">
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
      <div class="px-4 py-3 border-b border-gray-100 flex items-center justify-between">
        <div class="flex items-center space-x-3 text-sm">
          <span class="font-medium text-gray-900">All notifications</span>
        </div>
      </div>
      <div id="notification-center-list" class="divide-y divide-gray-50">
        <div class="p-4 text-sm text-gray-500" id="notification-center-loading">Loading notifications...</div>
      </div>
      <div class="px-4 py-3 border-t border-gray-100 flex items-center justify-between">
        <p class="text-xs text-gray-500" id="notification-center-summary"></p>
        <div class="space-x-2">
          <button type="button" id="notification-center-prev" class="hidden text-xs text-gray-600 hover:text-gray-900">Previous</button>
          <button type="button" id="notification-center-next" class="hidden text-xs text-blue-600 hover:text-blue-800">Next</button>
        </div>
      </div>
    </div>
  </div>

  <div class="space-y-4">
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
      <h2 class="text-sm font-semibold text-gray-900 mb-3">Filters</h2>
      <div class="space-y-3 text-xs">
        <div>
          <label class="block text-gray-500 mb-1">Status</label>
          <select id="filter-unread" class="w-full rounded-md border-gray-200 text-sm">
            <option value="">All</option>
            <option value="true">Unread only</option>
          </select>
        </div>
        <div>
          <label class="block text-gray-500 mb-1">Priority</label>
          <select id="filter-priority" class="w-full rounded-md border-gray-200 text-sm">
            <option value="">All</option>
            <option value="critical">Critical</option>
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
          </select>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
      <h2 class="text-sm font-semibold text-gray-900 mb-3">Notification Settings</h2>
      <p class="text-xs text-gray-500 mb-3">Fine-tune which alerts you receive. Tenant defaults are shown when no personal preference is set.</p>
      <div id="notification-preferences" class="space-y-2 text-xs">
        <p class="text-gray-400">Loading preferences...</p>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  let centerPage = 1;
  const centerPerPage = 15;

  function renderNotificationRow(notification) {
    const priorityLabels = {
      'critical': 'Critical',
      'high': 'High',
      'medium': 'Medium',
      'low': 'Low'
    };
    const priorityColors = {
      'critical': 'text-red-600',
      'high': 'text-orange-600',
      'medium': 'text-blue-600',
      'low': 'text-gray-600'
    };
    const timeAgo = getTimeAgo(new Date(notification.created_at));

    const div = document.createElement('button');
    div.type = 'button';
    div.className = 'w-full text-left p-4 flex items-start space-x-3 hover:bg-gray-25 focus:outline-none focus:bg-gray-25';
    if (!notification.is_read) {
      div.className += ' bg-blue-25';
    }
    div.onclick = function () { markAsReadAndNavigate(notification); };

    div.innerHTML = `
      <div class="flex-shrink-0 mt-1">
        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium bg-gray-50 ${priorityColors[notification.priority] || 'text-gray-600'}">
          ${priorityLabels[notification.priority] || 'Normal'}
        </span>
      </div>
      <div class="flex-1 min-w-0">
        <div class="flex items-center justify-between">
          <p class="text-sm font-medium text-gray-900">${notification.title}</p>
          ${!notification.is_read ? '<span class="w-2 h-2 bg-blue-500 rounded-full ml-2"></span>' : ''}
        </div>
        <p class="mt-1 text-xs text-gray-600 line-clamp-2">${notification.message}</p>
        <p class="mt-1 text-[11px] text-gray-400">${timeAgo}</p>
      </div>
    `;

    return div;
  }

  function loadNotificationCenter(page = 1) {
    const listEl = document.getElementById('notification-center-list');
    const loadingEl = document.getElementById('notification-center-loading');
    const summaryEl = document.getElementById('notification-center-summary');
    const prevBtn = document.getElementById('notification-center-prev');
    const nextBtn = document.getElementById('notification-center-next');

    const unreadFilter = document.getElementById('filter-unread').value;
    const priorityFilter = document.getElementById('filter-priority').value;

    let url = `/api/notifications/?page=${page}&per_page=${centerPerPage}`;
    if (unreadFilter === 'true') {
      url += '&unread_only=true';
    }
    if (priorityFilter) {
      url += `&priority=${encodeURIComponent(priorityFilter)}`;
    }

    loadingEl.style.display = 'block';

    fetch(url)
      .then(r => r.json())
      .then(data => {
        centerPage = page;
        listEl.innerHTML = '';

        if (!data.notifications.length) {
          listEl.innerHTML = '<div class="p-4 text-sm text-gray-500">No notifications found.</div>';
        } else {
          data.notifications.forEach(n => {
            listEl.appendChild(renderNotificationRow(n));
          });
        }

        summaryEl.textContent = `Page ${data.pagination.page} of ${data.pagination.pages} · ${data.pagination.total} total`;

        prevBtn.classList.toggle('hidden', !data.pagination.has_previous);
        nextBtn.classList.toggle('hidden', !data.pagination.has_next);

        loadingEl.style.display = 'none';
      })
      .catch(err => {
        console.error('Error loading notifications center:', err);
        listEl.innerHTML = '<div class="p-4 text-sm text-red-500">Error loading notifications.</div>';
        loadingEl.style.display = 'none';
      });
  }

  function loadNotificationPreferences() {
    const container = document.getElementById('notification-preferences');
    fetch('/api/notifications/preferences/')
      .then(r => r.json())
      .then(data => {
        const t = data.tenant_defaults || {};
        const u = data.user_preferences || {};

        function renderToggle(key, label) {
          const isOn = u[key];
          const fallback = t[key];
          const effective = (isOn === null || typeof isOn === 'undefined') ? fallback : isOn;

          const row = document.createElement('div');
          row.className = 'flex items-center justify-between';

          row.innerHTML = `
            <div>
              <p class="text-xs font-medium text-gray-800">${label}</p>
              <p class="text-[11px] text-gray-400">${fallback ? 'On by default' : 'Off by default'}</p>
            </div>
            <button type="button" data-key="${key}" class="ml-3 inline-flex h-5 w-9 items-center rounded-full border transition-colors ${effective ? 'bg-blue-600 border-blue-600' : 'bg-gray-200 border-gray-200'}">
              <span class="inline-block h-4 w-4 transform rounded-full bg-white shadow transition-transform ${effective ? 'translate-x-4' : 'translate-x-0'}"></span>
            </button>
          `;

          return row;
        }

        container.innerHTML = '';
        container.appendChild(renderToggle('policy_expiry_enabled', 'Policy expiry alerts'));
        container.appendChild(renderToggle('payment_notifications_enabled', 'Payment & verification alerts'));
        container.appendChild(renderToggle('compliance_alerts_enabled', 'Compliance & cancellations'));
        container.appendChild(renderToggle('system_notifications_enabled', 'System announcements'));

        container.addEventListener('click', function (event) {
          const btn = event.target.closest('button[data-key]');
          if (!btn) return;
          const key = btn.getAttribute('data-key');

          const payload = {};
          const isActive = btn.classList.contains('bg-blue-600');
          payload[key] = !isActive;

          fetch('/api/notifications/preferences/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCsrfToken(),
            },
            body: JSON.stringify(payload),
          }).then(r => {
            if (r.ok) {
              loadNotificationPreferences();
            }
          });
        }, { once: true });
      })
      .catch(err => {
        console.error('Error loading notification preferences:', err);
        container.innerHTML = '<p class="text-xs text-red-500">Error loading preferences.</p>';
      });
  }

  document.addEventListener('DOMContentLoaded', function () {
    const prevBtn = document.getElementById('notification-center-prev');
    const nextBtn = document.getElementById('notification-center-next');

    if (prevBtn && nextBtn) {
      prevBtn.addEventListener('click', function () {
        if (centerPage > 1) {
          loadNotificationCenter(centerPage - 1);
        }
      });
      nextBtn.addEventListener('click', function () {
        loadNotificationCenter(centerPage + 1);
      });
    }

    const unreadSelect = document.getElementById('filter-unread');
    const prioritySelect = document.getElementById('filter-priority');
    if (unreadSelect && prioritySelect) {
      unreadSelect.addEventListener('change', function () { loadNotificationCenter(1); });
      prioritySelect.addEventListener('change', function () { loadNotificationCenter(1); });
    }

    loadNotificationCenter(1);
    loadNotificationPreferences();
  });
</script>
{% endblock %}
