{% extends "base.html" %}
{% block content %}
<div class="flex flex-wrap items-center justify-between gap-3 mb-4">
  <div>
    <h1 class="text-xl font-semibold">Staff Access</h1>
    <p class="text-sm text-gray-600">Assign which vehicle types each staff member can manage and review their activity.</p>
  </div>
  {% if request.user.role == 'admin' %}
  <div>
    <a href="{% url 'dashboard:staff_create' %}" class="inline-flex items-center rounded bg-sky-600 px-4 py-2 text-white hover:bg-sky-700 text-sm">New Staff</a>
  </div>
  {% endif %}
</div>

<form method="get" class="grid grid-cols-12 gap-3 mb-4" aria-label="Filter staff">
  <div class="col-span-12 md:col-span-6">
    <input type="text" name="q" value="{{ request.GET.q }}" placeholder="Search by name, email, or username" class="block w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
  </div>
  <div class="col-span-12 md:col-span-3">
    <select name="role" class="block w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
      <option value="">Any role</option>
      <option value="admin" {% if request.GET.role == 'admin' %}selected{% endif %}>Admin</option>
      <option value="manager" {% if request.GET.role == 'manager' %}selected{% endif %}>Manager</option>
      <option value="agent" {% if request.GET.role == 'agent' %}selected{% endif %}>Agent</option>
    </select>
  </div>
  <div class="col-span-12 md:col-span-3">
    <button type="submit" class="w-full inline-flex items-center justify-center rounded border border-gray-300 px-3 py-2 text-sm hover:bg-gray-50">Filter</button>
  </div>
</form>

<div class="overflow-x-auto rounded border border-gray-200 bg-white">
  <table class="min-w-full text-sm" aria-label="Staff access and activity overview">
    <thead class="bg-gray-50 text-left text-gray-600">
      <tr>
        <th scope="col" class="px-3 py-2">User</th>
        <th scope="col" class="px-3 py-2">Role</th>
        <th scope="col" class="px-3 py-2">Vehicle Types</th>
        <th scope="col" class="px-3 py-2">Metrics</th>
        <th scope="col" class="px-3 py-2 text-right">Actions</th>
      </tr>
    </thead>
    <tbody class="divide-y divide-gray-100">
      {% for row in staff_access %}
        <tr class="hover:bg-gray-50">
          <td class="px-3 py-2">
            <div class="font-medium">{{ row.user.get_full_name|default:row.user.username }}</div>
            <div class="text-xs text-gray-500">{{ row.user.email }}</div>
          </td>
          <td class="px-3 py-2">{{ row.user.get_role_display|default:row.user.role }}</td>
          <td class="px-3 py-2">
            <ul class="list-disc pl-4">
              {% for label in row.vehicle_types %}
                <li>{{ label }}</li>
              {% endfor %}
            </ul>
          </td>
          <td class="px-3 py-2">
            <div class="text-xs text-gray-600 space-y-1">
              <div>Customers: <span class="font-medium">{{ row.metrics.customers }}</span></div>
              <div>Vehicles: <span class="font-medium">{{ row.metrics.vehicles }}</span></div>
              <div>Policies: <span class="font-medium">{{ row.metrics.policies }}</span></div>
              <div>Payments recorded: <span class="font-medium">{{ row.metrics.payments_recorded }}</span></div>
              <div>Payments verified: <span class="font-medium">{{ row.metrics.payments_verified }}</span></div>
            </div>
          </td>
          <td class="px-3 py-2 text-right">
            <a class="inline-flex items-center rounded border border-sky-600 text-sky-700 hover:bg-sky-50 px-2 py-1" href="{% url 'dashboard:staff_vehicle_types' row.user.pk %}">
              Edit Access
            </a>
            {% if request.user.role == 'admin' %}
            <form method="post" action="{% url 'accounts:staff_force_reset_password' row.user.pk %}" class="inline-block ml-2">
              {% csrf_token %}
              <button type="submit" class="inline-flex items-center rounded border border-red-500 text-red-600 hover:bg-red-50 px-2 py-1 text-xs">
                Reset Password
              </button>
            </form>
            {% endif %}
          </td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="5" class="px-3 py-6 text-center text-gray-500">
            <div class="space-y-2">
              <p>No staff users found for this organization.</p>
              {% if request.user.role == 'admin' %}
                <a href="{% url 'dashboard:staff_create' %}" class="inline-flex items-center rounded bg-sky-600 px-3 py-2 text-sm text-white hover:bg-sky-700">Add first staff member</a>
              {% endif %}
            </div>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
