{% extends "base.html" %}
{% block content %}
<div class="flex flex-wrap items-center justify-between gap-3 mb-4">
  <div>
    <h1 class="text-xl font-semibold">Customers</h1>
  </div>
  <div class="flex flex-wrap gap-2">
    <a href="{% url 'dashboard:customers_create' %}" class="inline-flex items-center rounded bg-sky-600 px-3 py-2 text-white hover:bg-sky-700">New Customer</a>
    {% if request.user.role == 'admin' or request.user.role == 'manager' %}
      <a href="{% url 'dashboard:customers_export' %}?{{ request.GET.urlencode }}" class="inline-flex items-center rounded border border-gray-300 px-3 py-2 text-sm hover:bg-gray-50">Export CSV</a>
    {% endif %}
  </div>
</div>

<form method="get" class="grid grid-cols-12 gap-3 mb-4" role="search" aria-label="Search customers">
  <div class="col-span-12 md:col-span-4">
    <label class="sr-only" for="id_customer_search">Search customers</label>
    <input id="id_customer_search" type="text" name="q" placeholder="Search name, email, phone, ID, registration" value="{{ request.GET.q }}" class="block w-full rounded-md border border-gray-300 px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500" />
  </div>
  <div class="col-span-12 md:col-span-3">
    <select name="customer_type" class="block w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
      <option value="">All Types</option>
      <option value="individual"{% if current_customer_type == 'individual' %} selected{% endif %}>Individuals</option>
      <option value="company"{% if current_customer_type == 'company' %} selected{% endif %}>Companies</option>
    </select>
  </div>
  <div class="col-span-12 md:col-span-2">
    <select name="has_vehicles" class="block w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
      <option value="">All Vehicles</option>
      <option value="yes"{% if current_has_vehicles == 'yes' %} selected{% endif %}>Has Vehicles</option>
      <option value="no"{% if current_has_vehicles == 'no' %} selected{% endif %}>No Vehicles</option>
    </select>
  </div>
  <div class="col-span-6 md:col-span-1">
    <button class="w-full inline-flex items-center justify-center rounded border border-gray-300 px-3 py-2 text-sm hover:bg-gray-50" type="submit">Filter</button>
  </div>
  <div class="col-span-6 md:col-span-1">
    <a class="w-full inline-flex items-center justify-center rounded border border-gray-300 px-3 py-2 text-sm hover:bg-gray-50" href="{% url 'dashboard:customers_list' %}">Clear</a>
  </div>
  <div class="col-span-6 md:col-span-1">
    <label class="sr-only" for="id_created_from">Created from</label>
    <input id="id_created_from" type="date" name="created_from" value="{{ created_from }}" class="block w-full rounded-md border border-gray-300 px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500" />
  </div>
  <div class="col-span-6 md:col-span-1">
    <label class="sr-only" for="id_created_to">Created to</label>
    <input id="id_created_to" type="date" name="created_to" value="{{ created_to }}" class="block w-full rounded-md border border-gray-300 px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500" />
  </div>
</form>

<div class="overflow-x-auto rounded border border-gray-200 bg-white">
  <table class="min-w-full text-sm">
    <caption class="sr-only">Tenant customer list</caption>
    <thead class="bg-gray-50 text-left text-gray-600">
      <tr>
        <th class="px-3 py-2">Name</th>
        <th class="px-3 py-2">Type</th>
        <th class="px-3 py-2">Email</th>
        <th class="px-3 py-2">Phone</th>
        <th class="px-3 py-2">Vehicles</th>
        <th class="px-3 py-2">Created</th>
        <th class="px-3 py-2 text-right">Actions</th>
      </tr>
    </thead>
    <tbody class="divide-y divide-gray-100">
      {% for c in customers %}
      <tr class="hover:bg-gray-50">
        <td class="px-3 py-2">
          {% if c.customer_type == 'individual' %}
            {{ c.first_name }} {{ c.last_name }}
          {% else %}
            {{ c.company_name }}
          {% endif %}
        </td>
        <td class="px-3 py-2">
          <span class="inline-flex rounded-full px-2 py-0.5 text-xs font-medium {% if c.customer_type == 'company' %}bg-indigo-50 text-indigo-700{% else %}bg-emerald-50 text-emerald-700{% endif %}">
            {{ c.get_customer_type_display }}
          </span>
        </td>
        <td class="px-3 py-2">{{ c.email }}</td>
        <td class="px-3 py-2">{{ c.phone }}</td>
        <td class="px-3 py-2">{{ c.vehicle_count }}</td>
        <td class="px-3 py-2">{{ c.created_at|date:"Y-m-d" }}</td>
        <td class="px-3 py-2 text-right">
          <a href="{% url 'dashboard:vehicles_list' %}?owner={{ c.pk }}" class="inline-flex items-center rounded border border-gray-300 px-2 py-1 hover:bg-gray-50">Vehicles</a>
          <a href="{% url 'dashboard:vehicles_create' %}?owner={{ c.pk }}" class="inline-flex items-center rounded border border-emerald-600 text-emerald-700 hover:bg-emerald-50 px-2 py-1 ml-1">Add Vehicle</a>
          <a href="{% url 'dashboard:customers_update' c.pk %}" class="inline-flex items-center rounded border border-sky-600 text-sky-700 hover:bg-sky-50 px-2 py-1 ml-1">Edit</a>
          {% if request.user.role == 'admin' or request.user.role == 'manager' %}
            {% if c.vehicle_count > 0 %}
              <span class="inline-flex items-center rounded border border-gray-200 px-2 py-1 text-gray-400 ml-1" title="Customer has vehicles and cannot be deleted">Delete</span>
            {% else %}
              <form method="post" action="{% url 'dashboard:customers_delete' c.pk %}" class="inline" onsubmit="return confirm('Delete this customer?');">
                {% csrf_token %}
                <button type="submit" class="inline-flex items-center rounded border border-red-600 text-red-700 hover:bg-red-50 px-2 py-1 ml-1">Delete</button>
              </form>
            {% endif %}
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="7" class="px-3 py-6 text-center text-gray-500">
          {% if onboarding_needed %}
            <div class="space-y-2">
              <p>No customers yet. Add the vehicle owner to finish onboarding.</p>
              <a href="{% url 'dashboard:onboarding_owner' %}" class="inline-flex items-center rounded bg-sky-600 px-3 py-2 text-sm text-white hover:bg-sky-700">Continue onboarding</a>
            </div>
          {% else %}
            No customers found.
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="mt-4 flex items-center gap-2 text-sm">
  {% if page_obj.has_previous %}
    <a class="rounded border px-2 py-1 hover:bg-gray-50" aria-label="First page of customers" href="?page=1{% if querystring %}&{{ querystring }}{% endif %}">First</a>
    <a class="rounded border px-2 py-1 hover:bg-gray-50" aria-label="Previous page of customers" href="?page={{ page_obj.previous_page_number }}{% if querystring %}&{{ querystring }}{% endif %}">Prev</a>
  {% else %}
    <span class="rounded border px-2 py-1 opacity-50 cursor-not-allowed" aria-hidden="true">First</span>
    <span class="rounded border px-2 py-1 opacity-50 cursor-not-allowed" aria-hidden="true">Prev</span>
  {% endif %}

  <span class="px-2 py-1">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

  {% if page_obj.has_next %}
    <a class="rounded border px-2 py-1 hover:bg-gray-50" aria-label="Next page of customers" href="?page={{ page_obj.next_page_number }}{% if querystring %}&{{ querystring }}{% endif %}">Next</a>
    <a class="rounded border px-2 py-1 hover:bg-gray-50" aria-label="Last page of customers" href="?page={{ page_obj.paginator.num_pages }}{% if querystring %}&{{ querystring }}{% endif %}">Last</a>
  {% else %}
    <span class="rounded border px-2 py-1 opacity-50 cursor-not-allowed" aria-hidden="true">Next</span>
    <span class="rounded border px-2 py-1 opacity-50 cursor-not-allowed" aria-hidden="true">Last</span>
  {% endif %}
</div>
{% endblock %}
